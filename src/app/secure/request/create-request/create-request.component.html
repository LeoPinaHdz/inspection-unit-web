<div>
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <a [routerLink]="['/secure/requests']" class="button-back" color="accent" mat-mini-fab>
          <mat-icon>arrow_circle_left</mat-icon>
        </a>
        {{ isEdit ? 'Detalle de solicitud' : 'Nueva solicitud' }}
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="requestForm">
        <div class="form-container">
          <div class="form-cell-3">
            <mat-form-field appearance="outline">
              <mat-label>Folio</mat-label>
              <input matInput formControlName="clave" type="text" />
              <mat-error>
                <error-message nomCampo="Folio"></error-message>
              </mat-error>
            </mat-form-field>
          </div>
          <div class="form-cell-3">
            <mat-form-field appearance="outline">
              <mat-label>Pedimento</mat-label>
              <input matInput formControlName="pedimento" type="text" />
              <mat-error>
                <error-message nomCampo="Pedimento"></error-message>
              </mat-error>
            </mat-form-field>
          </div>
          <div class="form-cell-3">
            <mat-label>Tipo de servicio</mat-label>
            <br>
            <mat-radio-group formControlName="tipoServicio" aria-label="Select an option">
              <mat-radio-button value="0">Constancia</mat-radio-button>
              <mat-radio-button value="1">Dictamen</mat-radio-button>
            </mat-radio-group>
          </div>
          <div class="form-cell-3">
            <mat-label>Tipo de depósito</mat-label>
            <br>
            <mat-radio-group formControlName="tipoRegimen" aria-label="Select an option">
              <mat-radio-button value="0">Nacional</mat-radio-button>
              <mat-radio-button value="1">Fiscal</mat-radio-button>
            </mat-radio-group>
          </div>
          <div class="form-cell-6">
            <mat-form-field appearance="outline">
              <mat-label>Cliente</mat-label>
              <mat-select formControlName="idCliente" placeholder="Cliente" #clientSelect>
                <mat-option>
                  <ngx-mat-select-search placeholderLabel="Busca cliente"
                    noEntriesFoundLabel="No se encontraron resultados"
                    formControlName="clientFilter"></ngx-mat-select-search>
                </mat-option>
                <mat-option *ngFor="let client of filteredClients | async" [value]="client.idCliente">
                  {{client.nombre}}
                </mat-option>
              </mat-select>
              <mat-error>
                <error-message nomCampo="Cliente"></error-message>
              </mat-error>
            </mat-form-field>
          </div>
          <div class="form-cell-6">
            <mat-form-field appearance="outline">
              <mat-label>Norma oficial</mat-label>
              <mat-select formControlName="idNorma" required>
                <mat-option *ngFor="let standard of standards"
                  [value]="standard.idNorma">{{standard.nombre}}</mat-option>
              </mat-select>
              <mat-error>
                <error-message nomCampo="Norma"></error-message>
              </mat-error>
            </mat-form-field>
          </div>
          <div class="form-cell-12">
            <mat-divider></mat-divider>
          </div>
          <div class="form-cell-6">
            <mat-form-field appearance="outline">
              <mat-label>Lugar inspección</mat-label>
              <mat-select formControlName="idLugar" required>
                <mat-option *ngFor="let place of addresses" [value]="place.idLugar">{{place.nombre}}</mat-option>
              </mat-select>
              <mat-error>
                <error-message nomCampo="Lugar"></error-message>
              </mat-error>
            </mat-form-field>
          </div>
          <div class="form-cell-3">
            <mat-form-field>
              <mat-label>Fecha del solicitud</mat-label>
              <input matInput formControlName="fSolicitud" [matDatepicker]="fSolicitudPicker" required>
              <mat-hint>MM/DD/YYYY</mat-hint>
              <mat-datepicker-toggle matIconSuffix [for]="fSolicitudPicker"></mat-datepicker-toggle>
              <mat-datepicker #fSolicitudPicker></mat-datepicker>
            </mat-form-field>
          </div>
          <div class="form-cell-3">
            <mat-form-field>
              <mat-label>Fecha de programa</mat-label>
              <input matInput formControlName="fPrograma" [matDatepicker]="fProgramaPicker" required>
              <mat-hint>MM/DD/YYYY</mat-hint>
              <mat-datepicker-toggle matIconSuffix [for]="fProgramaPicker"></mat-datepicker-toggle>
              <mat-datepicker #fProgramaPicker></mat-datepicker>
            </mat-form-field>
          </div>
          <div class="form-cell-4" *ngIf="isEdit">
              <button matTooltip="Exportar" class="export-pdf" mat-fab extended (click)="downloadFile(0)">
                  <mat-icon>get_app</mat-icon>PDF
              </button>
              <button matTooltip="Exportar" class="export-word" mat-fab extended (click)="downloadFile(2)">
                  <mat-icon>get_app</mat-icon>WORD
              </button>
              <button matTooltip="Exportar" class="export-writer" mat-fab extended (click)="downloadFile(1)">
                  <mat-icon>get_app</mat-icon>WRITER
              </button>
          </div>
          <div class="form-cell-2" *ngIf="isEdit && form.tipoServicio.value == 0 && templates.length > 1">
            <mat-form-field appearance="outline">
              <mat-label>Formato</mat-label>
              <mat-select formControlName="idFormato">
                <mat-option *ngFor="let template of templates" [value]="template.idFormato">{{template.nombre}}</mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <mat-card>
    <mat-card-header>
      <mat-card-title>
        Detalle
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="requestDetailForm" class="form-container" *ngIf="!request.tipoServicio">
        <div class="form-cell-3">
          <mat-form-field class="mat-mdc-form-field-small" appearance="outline">
            <mat-label>Modelo</mat-label>
            <input matInput formControlName="modelo" appCurrencyMask type="text" required />
            <mat-error>
              <error-message [control]="form.modelo" nomCampo="Modelo"></error-message>
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-cell-3">
          <mat-form-field class="mat-mdc-form-field-small" appearance="outline">
            <mat-label>Producto</mat-label>
            <input matInput formControlName="producto" appCurrencyMask type="text" required />
            <mat-error>
              <error-message [control]="form.producto" nomCampo="Producto"></error-message>
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-cell-3">
          <mat-form-field class="mat-mdc-form-field-small" appearance="outline">
            <mat-label>Cantidad</mat-label>
            <input matInput formControlName="cantidad" appCurrencyMask type="number" required />
            <mat-error>
              <error-message [control]="form.cantidad" nomCampo="Cantidad"></error-message>
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-cell-3">
          <mat-form-field appearance="outline">
            <mat-label>Unidad</mat-label>
            <mat-select formControlName="idUnidad" required>
              <mat-option *ngFor="let unit of units" [value]="unit.idUnidad">{{unit.nombre}}</mat-option>
            </mat-select>
            <mat-error>
              <error-message nomCampo="Unidad"></error-message>
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-cell-3">
          <mat-form-field class="mat-mdc-form-field-small" appearance="outline">
            <mat-label>Marca</mat-label>
            <input matInput formControlName="marca" appCurrencyMask type="text" required />
            <mat-error>
              <error-message [control]="form.marca" nomCampo="Marca"></error-message>
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-cell-3">
          <mat-form-field class="mat-mdc-form-field-small" appearance="outline">
            <mat-label>Pa&iacute;s</mat-label>
            <input matInput formControlName="pais" appCurrencyMask type="text" required />
            <mat-error>
              <error-message [control]="form.pais" nomCampo="País"></error-message>
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-cell-2" *ngIf="selectedDetail">
          <button (click)="onCancelEdit()" mat-fab extended color="warn">Cancelar</button>
        </div>
        <div class="form-cell-2">
          <button type="button" (click)="onSubmitDetail()" mat-fab extended color="primary">{{!selectedDetail ||
            selectedDetail.producto === 0 ? 'Agregar' : 'Guardar'}}</button>
        </div>
      </form>

      <div *ngIf="requestDetails.length === 0" class="error-message">
        *La solicitud debe contener al menos un detalle
      </div>
      <table mat-table [dataSource]="dataSource" class="mat-elevation-z8">
        <ng-container matColumnDef="modelo">
          <th mat-header-cell *matHeaderCellDef>Modelo</th>
          <td mat-cell *matCellDef="let element"> {{element.modelo}} </td>
        </ng-container>
        <ng-container matColumnDef="producto">
          <th mat-header-cell *matHeaderCellDef>Producto</th>
          <td mat-cell *matCellDef="let element"> {{element.producto}} </td>
        </ng-container>
        <ng-container matColumnDef="cantidad">
          <th mat-header-cell *matHeaderCellDef>Cantidad</th>
          <td mat-cell *matCellDef="let element"> {{element.cantidad}} </td>
        </ng-container>
        <ng-container matColumnDef="idUnidad">
          <th mat-header-cell *matHeaderCellDef>UMC</th>
          <td mat-cell *matCellDef="let element"> {{element.nombreUnidad}} </td>
        </ng-container>
        <ng-container matColumnDef="marca">
          <th mat-header-cell *matHeaderCellDef>Marca</th>
          <td mat-cell *matCellDef="let element"> {{element.marca}} </td>
        </ng-container>
        <ng-container matColumnDef="pais">
          <th mat-header-cell *matHeaderCellDef>Pa&iacute;s</th>
          <td mat-cell *matCellDef="let element"> {{request.tipoServicio ? element.idPais : element.pais}} </td>
        </ng-container>
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let element">
            <button *ngIf="request.idEstatus === 1 && !selectedDetail && !request.tipoServicio" mat-mini-fab matTooltip="Editar" color="primary"
              (click)="editDetail(element)">
              <mat-icon>edit</mat-icon>
            </button>
            <button *ngIf="request.idEstatus === 1 && !request.tipoServicio" mat-mini-fab matTooltip="Eliminar" color="warn"
              (click)="showConfirmDeleteDialog(element)">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    </mat-card-content>
    <mat-card-footer>
      <button *ngIf="request.idEstatus === 1" (click)="onSubmit()" mat-fab extended>Guardar</button>
    </mat-card-footer>
  </mat-card>
</div>